## Comprehensive Adaptive TextBox Test
## Tests C++ adaptive properties with text that actually needs adaptation

define Start(p)
{
    gWin <- MakeWindow("grey80")

    ## Test text samples - these WILL need adaptation
    longText <- "This is a very long piece of text designed to thoroughly test the adaptive textbox functionality. It contains many sentences with enough content to ensure that it will require significant adaptation in most scenarios. The purpose is to verify that both the scalebox and scalefont strategies work correctly when dealing with substantial amounts of text that would normally overflow a standard textbox. We want to see how well each strategy handles this challenging case and whether the iterative font scaling or box scaling produces acceptable results."

    mediumText <- "This is a medium-length piece of text that might fit at larger font sizes but will need adaptation at smaller sizes or in narrow boxes. It contains enough words to demonstrate wrapping behavior across multiple lines."

    ##------------------------------------------------------------------------
    ## TEST 1: Long text in small box - REQUIRES adaptation
    ##------------------------------------------------------------------------
    Print("=" + RepeatString("=", 70))
    Print("TEST 1: Long text in small box (32pt -> small box)")
    Print("=" + RepeatString("=", 70))

    ## This WILL overflow - 32pt font in 400x100 box with lots of text
    label1 <- EasyLabel("ScaleFont Strategy:", 50, 50, gWin, 16)
    box1 <- AdaptiveTextBox(longText, 50, 80, gWin, 32, 400, 100, "scalefont")
    Draw()

    Print("Font size after adaptation: " + box1.font.size)
    Print("Lines rendered: " + box1.numTextLines)
    Print("Box dimensions: " + box1.width + "x" + box1.height)
    Print("")

    Wait(3000)
    Hide(label1)
    Hide(box1)

    ##------------------------------------------------------------------------
    ## TEST 2: Medium text that needs moderate adaptation
    ##------------------------------------------------------------------------
    Print("=" + RepeatString("=", 70))
    Print("TEST 2: Medium text in small box (24pt -> medium box)")
    Print("=" + RepeatString("=", 70))

    label2 <- EasyLabel("ScaleFont Strategy:", 50, 50, gWin, 16)
    box2 <- AdaptiveTextBox(mediumText, 50, 80, gWin, 24, 500, 120, "scalefont")
    Draw()

    Print("Font size after adaptation: " + box2.font.size)
    Print("Lines rendered: " + box2.numTextLines)
    Print("")

    Wait(3000)
    Hide(label2)
    Hide(box2)

    ##------------------------------------------------------------------------
    ## TEST 3: Narrow box - tests wrapping with adaptation
    ##------------------------------------------------------------------------
    Print("=" + RepeatString("=", 70))
    Print("TEST 3: Text in narrow box (20pt -> 150px wide)")
    Print("=" + RepeatString("=", 70))

    narrowText <- "This text is in a very narrow column and should wrap many times. Even with adaptation, this will create many lines of text."

    label3 <- EasyLabel("Narrow Box:", 50, 50, gWin, 16)
    box3 <- AdaptiveTextBox(narrowText, 50, 80, gWin, 20, 150, 150, "scalefont")
    Draw()

    Print("Font size after adaptation: " + box3.font.size)
    Print("Lines rendered: " + box3.numTextLines)
    Print("")

    Wait(3000)
    Hide(label3)
    Hide(box3)

    ##------------------------------------------------------------------------
    ## TEST 4: Re-adaptation test - change text after creation
    ##------------------------------------------------------------------------
    Print("=" + RepeatString("=", 70))
    Print("TEST 4: Re-adaptation test (change text dynamically)")
    Print("=" + RepeatString("=", 70))

    label4 <- EasyLabel("Dynamic Text Change:", 50, 50, gWin, 16)

    ## Start with short text
    shortText <- "Short text that fits easily."
    box4 <- AdaptiveTextBox(shortText, 50, 80, gWin, 28, 400, 120, "scalefont")
    Draw()

    Print("Initial short text - Font size: " + box4.font.size)
    Wait(2000)

    ## Change to long text - should NOT re-adapt (that's the bug we're testing)
    Print("Changing to long text...")
    box4.text <- longText
    Draw()

    Print("After text change - Font size: " + box4.font.size)
    Print("After text change - Lines: " + box4.numTextLines)
    Print("Note: If font size didn't change, re-adaptation is NOT working")
    Print("")

    Wait(3000)
    Hide(label4)
    Hide(box4)

    ##------------------------------------------------------------------------
    ## TEST 5: ScaleBox strategy comparison
    ##------------------------------------------------------------------------
    Print("=" + RepeatString("=", 70))
    Print("TEST 5: ScaleBox strategy (for comparison)")
    Print("=" + RepeatString("=", 70))

    label5 <- EasyLabel("ScaleBox Strategy:", 50, 50, gWin, 16)
    box5 <- AdaptiveTextBox(longText, 50, 80, gWin, 32, 400, 100, "scalebox")
    Draw()

    Print("Font size (should be unchanged): " + box5.font.size)
    Print("Lines rendered: " + box5.numTextLines)
    Print("Zoom factor: " + box5.zoomX + "x" + box5.zoomY)
    Print("")

    Wait(3000)

    ##------------------------------------------------------------------------
    ## Summary
    ##------------------------------------------------------------------------
    Hide(label5)
    Hide(box5)

    summary <- "ADAPTIVE TEXTBOX TEST COMPLETE" + CR(2) +
               "Results Summary:" + CR(2) +
               "TEST 1: Long text (32pt) should adapt to smaller font" + CR(1) +
               "TEST 2: Medium text (24pt) should adapt moderately" + CR(1) +
               "TEST 3: Narrow box should adapt for wrapping" + CR(1) +
               "TEST 4: Text change should trigger re-adaptation (BUG!)" + CR(1) +
               "TEST 5: ScaleBox maintains font, uses zoom instead" + CR(2) +
               "The key issue: TEST 4 shows that changing text" + CR(1) +
               "after creation does NOT re-adapt the font size." + CR(1) +
               "This is the bug that needs fixing."

    summaryBox <- EasyTextBox(summary, 100, 100, gWin, 18, 600, 400)
    Draw()

    Print("=" + RepeatString("=", 70))
    Print("All tests complete. Press any key to exit.")
    Print("=" + RepeatString("=", 70))

    WaitForAnyKeyPress()
}

## Helper function
define RepeatString(str, n)
{
    result <- ""
    loop(i, Sequence(1, n, 1))
    {
        result <- result + str
    }
    return result
}
