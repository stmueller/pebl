## Test textbox height calculation with flowing text

define Start(p)
{
  gWin <- MakeWindow("gray")

  ## Test with the actual INST text from luckvogel that's causing the problem
  text1 <- "In this task, you will be asked to remember a screen full of colored objects, like you see below.  The screen will appear briefly, disappear, and then a new screen will appear.  This new screen may or may not be the same as the previous screen.  Your job is to determine whether they are the same or different. On the following example trial, the screen won't change when it flashes. Press any key to see an example."

  Print("Text length: " + StringLength(text1) + " characters")

  ## Create textbox using EasyTextBox with a specific width
  font <- MakeFont(gPEBLBaseFont, 0, 16, MakeColor("black"), MakeColor("white"), 1)

  width <- 600

  ## Let's manually calculate what height we need
  ## First, let's see what the auto-layout creates
  textbox1 <- MakeTextBox(text1, font, width, 200)
  AddObject(textbox1, gWin)
  Move(textbox1, 100, 100)

  ## Draw a red box around where the textbox should be - use MoveCorner to position by upper-left like textbox
  rect <- Rectangle(100, 100, width, 200, MakeColor("red"), 0)
  AddObject(rect, gWin)
  MoveCorner(rect, 100, 100)

  Draw()

  Print("TextBox properties:")
  Print("  NUMTEXTLINES: " + textbox1.NUMTEXTLINES)
  Print("  TEXTCOMPLETE: " + textbox1.TEXTCOMPLETE)
  Print("  LINEHEIGHT: " + textbox1.LINEHEIGHT)
  Print("  WIDTH: " + textbox1.WIDTH)
  Print("  HEIGHT: " + textbox1.HEIGHT)

  WaitForAnyKeyPress()

  ## Now test with calculated height
  height2 <- textbox1.NUMTEXTLINES * textbox1.LINEHEIGHT + 10
  Print("Calculated height needed: " + height2)

  RemoveObject(textbox1, gWin)
  RemoveObject(rect, gWin)

  textbox2 <- MakeTextBox(text1, font, width, height2)
  ## Make it adaptive so it will resize font when text overflows
  textbox2.ISADAPTIVE <- 1
  textbox2.REQUESTEDFONTSIZE <- 16
  AddObject(textbox2, gWin)
  Move(textbox2, 100, 100)

  rect2 <- Rectangle(100, 100, width, height2, MakeColor("blue"), 0)
  AddObject(rect2, gWin)
  MoveCorner(rect2, 100, 100)

  Draw()

  Print("After resize:")
  Print("  NUMTEXTLINES: " + textbox2.NUMTEXTLINES)
  Print("  TEXTCOMPLETE: " + textbox2.TEXTCOMPLETE)

  WaitForAnyKeyPress()

  ## Now add more text to trigger overflow
  Print("Adding more text to trigger overflow...")
  moreText <- text1 + " Here are some extra words to make the text overflow."
  SetText(textbox2, moreText)

  Draw()

  Print("After adding text:")
  Print("  NUMTEXTLINES: " + textbox2.NUMTEXTLINES)
  Print("  TEXTCOMPLETE: " + textbox2.TEXTCOMPLETE)
  Print("  LINEHEIGHT: " + textbox2.LINEHEIGHT)
  Print("  FONT SIZE: " + textbox2.FONT.SIZE)
  Print("  REQUESTEDFONTSIZE: " + textbox2.REQUESTEDFONTSIZE)
  Print("  Text now " + StringLength(moreText) + " characters")

  WaitForAnyKeyPress()
}
