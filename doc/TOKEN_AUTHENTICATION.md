# Token-Based Authentication for PEBL Emscripten Build

## Overview

This document describes the token-based authentication system implemented for PEBL's Emscripten/WebAssembly build. This enables multiple researchers to use a single compiled binary without recompilation.

## Problem Solved

Previously, `upload.json` configuration (containing server credentials and task info) was preloaded into the WASM binary at compile time. Each researcher would need their own custom compilation, which was not scalable.

## Solution: URL-Based Token Authentication (Architecture Option 3)

Researchers share URLs with embedded tokens:
```
https://yourserver.com/pebl2.html?token=abc123xyz&server=example.com&port=8080&task=taskname
```

The shell HTML extracts these parameters and dynamically creates `upload.json` in the virtual filesystem **before** PEBL starts.

## Implementation Details

### URL Parameters

| Parameter | Required | Default | Description |
|-----------|----------|---------|-------------|
| `token` | Yes | - | Authentication token (generated by researcher management system) |
| `server` | No | localhost | Upload server hostname |
| `port` | No | 8080 | Upload server port |
| `task` | No | unknown | Task/experiment identifier |

### Example URLs

**With all parameters:**
```
pebl2.html?token=abc123&server=obereed.net&port=443&task=corsi
```

**Minimal (uses defaults):**
```
pebl2.html?token=abc123
```

**Without token (falls back to preloaded upload.json if available):**
```
pebl2.html
```

## File Changes

### 1. Shell HTML (`emscripten/shell_PEBL_debug.html`)

**Lines 152-160: URL Parameter Extraction**
```javascript
const urlParams = new URLSearchParams(window.location.search);
const token = urlParams.get('token');
const server = urlParams.get('server') || 'localhost';
const port = urlParams.get('port') || '8080';
const taskname = urlParams.get('task') || 'unknown';
```

**Lines 202-226: Dynamic upload.json Creation**
```javascript
if (token) {
  const uploadConfig = {
    host: server,
    page: "/uploadPEBL.php",
    subnumpage: "/getNewSubNum.php",
    port: parseInt(port),
    token: token,
    taskname: taskname,
    username: "token_user",  // Placeholder for compatibility
    uploadpassword: "token_auth"  // Placeholder for compatibility
  };
  FS.writeFile('/upload.json', JSON.stringify(uploadConfig, null, 2));
}
```

### 2. Utility Library (`pebl-lib/Utility.pbl` and `emscripten/pebl-lib/Utility.pbl`)

**Updated Functions:**

**`UploadFile()` - Lines 1861-1889**
- Checks if `token` field exists in upload.json
- Uses token-based authentication if present
- Falls back to username/password if not

```pebl
if(IsMember(settings, "token"))
{
  token <- settings.token
  username <- "token_user"  // Placeholder
  uploadpassword <- "token_auth"  // Placeholder
} else {
  username <- settings.username
  uploadpassword <- settings.uploadpassword
}
```

**`SyncDataFile()` - Lines 1891-1933**
- Accepts optional `token` parameter (default: "")
- Adds `auth_token` field to POST data if token provided
- Server can validate token instead of username/password

```pebl
if(token != "")
{
  args <- Append(args, "auth_token")
  args <- Append(args, token)
}
```

## How It Works

### Execution Flow

1. **Browser loads** `pebl2.html` with URL parameters
2. **JavaScript extracts** token and config from URL
3. **PEBL module loads** (Emscripten initialization)
4. **IDBFS mounts** (if available) at `/data`
5. **upload.json created** from URL parameters, written to virtual filesystem
6. **PEBL starts** (`instance.callMain()`)
7. **Battery task calls** `UploadFile(subnum, datafile)`
8. **UploadFile reads** `/upload.json`, detects token
9. **SyncDataFile sends** POST with `auth_token` field
10. **Server validates** token and stores data

### Virtual Filesystem Injection

The key innovation is writing `upload.json` to the Emscripten virtual filesystem **after** the module loads but **before** `main()` executes:

```javascript
createPEBLModule(Module).then(function(instance) {
  var FS = instance.FS;
  // ... IDBFS setup ...
  FS.writeFile('/upload.json', configJson);  // Inject config
  instance.callMain();  // Now start PEBL
});
```

From PEBL's perspective, `upload.json` simply exists on disk. It doesn't know it was dynamically created from URL parameters.

## Testing

### Test Script: `demo/tests/test-token-config.pbl`

This script verifies token configuration:
- Checks if `upload.json` exists
- Reads and parses the configuration
- Displays all fields (host, port, taskname, token)
- Shows whether token or username/password auth is being used

### How to Test

1. **Compile:**
   ```bash
   make em-opt
   ```

2. **Serve locally:**
   ```bash
   cd bin
   python3 -m http.server 8000
   ```

3. **Test WITH token:**
   ```
   http://localhost:8000/pebl2.html?token=test123&server=example.com&port=443&task=mytest
   ```

4. **Test WITHOUT token:**
   ```
   http://localhost:8000/pebl2.html
   ```

5. **Check console output:**
   - Browser console (F12) shows URL parameters extracted
   - Browser console shows upload.json creation
   - PEBL output shows parsed configuration

### Expected Output (with token)

**Browser Console:**
```
URL Parameters: {token: "test123", server: "example.com", port: "443", task: "mytest"}
Creating token-based upload.json configuration...
Upload configuration written to /upload.json: {host: "example.com", port: 443, ...}
```

**PEBL Output:**
```
=== PEBL Token-Based Configuration Test ===

upload.json exists: 1

Reading upload.json...
Parsed configuration:
  host: example.com
  port: 443
  page: /uploadPEBL.php
  taskname: mytest
  token: test123 (length: 7)

✓ Token-based authentication configured!
```

## Server-Side Integration

### POST Data Format

When using token authentication, the upload POST request includes:

```
user_name: token_user
upload_password: token_auth
taskname: corsi
subnum: 1001
auth_token: abc123xyz
fileToUpload: [file data]
```

### Server Implementation

The PHP server (or other backend) should:

1. **Check for `auth_token` field**
   ```php
   if (isset($_POST['auth_token'])) {
       // Token-based authentication
       $token = $_POST['auth_token'];
       $valid = validateToken($token);  // Your validation logic
   } else {
       // Legacy username/password authentication
       $username = $_POST['user_name'];
       $password = $_POST['upload_password'];
       $valid = validateCredentials($username, $password);
   }
   ```

2. **Validate token**
   - Check token exists in database
   - Verify not expired
   - Check rate limits
   - Map token → researcher account/study

3. **Store data with proper attribution**
   ```php
   $studyId = getStudyFromToken($token);
   $researcherId = getResearcherFromToken($token);
   // Store file in appropriate directory/database
   ```

## Token Management System (Recommended)

For production use, implement:

### Token Generation
- Researcher creates study via web interface
- System generates unique token (UUID or secure random string)
- Token associated with:
  - Researcher account
  - Study/experiment ID
  - Expiration date
  - Rate limits
  - Allowed tasks

### Token Storage
```sql
CREATE TABLE auth_tokens (
    token VARCHAR(64) PRIMARY KEY,
    researcher_id INT,
    study_id INT,
    task_name VARCHAR(100),
    created_at TIMESTAMP,
    expires_at TIMESTAMP,
    max_uploads INT,
    upload_count INT DEFAULT 0,
    active BOOLEAN DEFAULT TRUE
);
```

### Token Validation
- Check token exists and is active
- Verify not expired
- Check upload count under limit
- Increment upload counter
- Log usage for auditing

## Backward Compatibility

The system maintains full backward compatibility:

1. **Preloaded upload.json still works**
   - If no token in URL, PEBL uses preloaded config
   - Existing battery tasks unchanged

2. **Username/password authentication**
   - If token field not present in upload.json
   - Falls back to traditional username/password
   - Legacy servers continue working

3. **Mixed deployments**
   - Some researchers can use tokens
   - Others can use hardcoded configs
   - Same binary supports both

## Security Considerations

### HTTPS Required
- Tokens in URLs are visible in browser history
- Use HTTPS to encrypt traffic
- Consider using POST for token transmission (future enhancement)

### Token Security
- Generate cryptographically secure tokens
- Implement expiration dates
- Allow token revocation
- Rate limit uploads per token
- Log all token usage

### URL Exposure
- Tokens visible in browser history
- Tokens may appear in server logs
- Consider short-lived tokens
- Implement token refresh mechanism

### CORS Configuration
- Server must allow cross-origin requests from PEBL domain
- Restrict to specific origins if possible
- Validate Origin header server-side

## Future Enhancements

### 1. POST-based Configuration
Instead of URL params, fetch config via POST:
```javascript
fetch('/api/study-config', {
  method: 'POST',
  body: JSON.stringify({sessionId: urlParams.get('session')})
})
```

### 2. Token Refresh
- Short-lived access tokens
- Long-lived refresh tokens
- Automatic renewal during experiment

### 3. Offline Support
- Cache token in IDBFS
- Allow experiments to complete offline
- Queue uploads for when online

### 4. Progress Tracking
- Server sends back progress updates
- Subject sees completion percentage
- Researcher dashboard shows real-time status

## Troubleshooting

### "No token provided" Warning
**Symptom:** Console shows "No token provided in URL"
**Solution:** Add `?token=YOUR_TOKEN` to URL

### upload.json Not Found
**Symptom:** PEBL reports "upload.json not found"
**Cause:** JavaScript failed to write file
**Check:**
- Browser console for errors
- FS available before callMain?
- Token parameter actually present?

### Upload Fails with 403
**Symptom:** Server returns 403 Forbidden
**Cause:** Token invalid or expired
**Check:**
- Token exists in database
- Token not expired
- Token active flag set

### Token Not Sent to Server
**Symptom:** Server doesn't receive auth_token field
**Cause:** PEBL library not updated
**Solution:** Rebuild with `make em-opt` to include updated Utility.pbl

## Files Modified

```
emscripten/shell_PEBL_debug.html        # URL param extraction, FS injection
pebl-lib/Utility.pbl                     # Token support in UploadFile/SyncDataFile
emscripten/pebl-lib/Utility.pbl          # Same changes (packaged in WASM)
demo/tests/test-token-config.pbl        # Test script to verify config
Makefile                                 # Updated to use test script
```

## Summary

Token-based authentication enables:
- ✅ Single compiled binary for all researchers
- ✅ No recompilation needed per researcher
- ✅ Dynamic configuration via URL parameters
- ✅ Secure token-based access control
- ✅ Backward compatible with existing systems
- ✅ Server-side researcher/study management
- ✅ Token revocation and expiration support

The implementation leverages Emscripten's virtual filesystem and the `noInitialRun` pattern to inject configuration before PEBL executes, making the multi-researcher architecture transparent to the PEBL code itself.
