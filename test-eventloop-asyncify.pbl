## test-eventloop-asyncify.pbl
## Test if native C++ event loop functions work with ASYNCIFY
## Run on emscripten with EM.pbl temporarily disabled to test native C++ implementations
##
## This script tests whether ASYNCIFY allows native C++ event loop functions
## to work correctly in the browser, potentially making EM.pbl overrides obsolete.

define Start()
{
  gWin <- MakeWindow("grey")

  ## Display test title
  title <- EasyLabel("PEBL Event Loop ASYNCIFY Test", gVideoWidth/2, 50, gWin, 28)
  output <- EasyLabel("", gVideoWidth/2, 120, gWin, 18)
  SetProperty(output, "VERTICALALIGN", "top")
  Draw()

  results <- []

  ## Test 1: Wait()
  PrintTest(output, "Test 1: Wait(500)")
  t1 <- GetTime()
  Wait(500)
  t2 <- GetTime()
  elapsed <- t2 - t1
  result1 <- "Wait completed in " + elapsed + "ms (expected ~500ms)"
  if(elapsed >= 450 and elapsed <= 550)
  {
    result1 <- result1 + " - PASS"
  } else {
    result1 <- result1 + " - FAIL"
  }
  PushOnEnd(results, result1)
  PrintTest(output, result1)
  Wait(1000)

  ## Test 2: WaitForAnyKeyPress()
  PrintTest(output, CR(1) + "Test 2: WaitForAnyKeyPress()" + CR(1) + "Press any key...")
  t1 <- GetTime()
  key <- WaitForAnyKeyPress()
  t2 <- GetTime()
  elapsed <- t2 - t1
  result2 <- "Key pressed: " + key + " after " + elapsed + "ms - PASS"
  PushOnEnd(results, result2)
  PrintTest(output, result2)
  Wait(1000)

  ## Test 3: WaitForMouseButton()
  PrintTest(output, CR(1) + "Test 3: WaitForMouseButton()" + CR(1) + "Click mouse anywhere...")
  t1 <- GetTime()
  click <- WaitForMouseButton()
  t2 <- GetTime()
  elapsed <- t2 - t1
  result3 <- "Mouse clicked at [" + First(click) + "," + Second(click) + "] after " + elapsed + "ms - PASS"
  PushOnEnd(results, result3)
  PrintTest(output, result3)
  Wait(1000)

  ## Test 4: WaitForKeyPressWithTimeout() - with timeout
  PrintTest(output, CR(1) + "Test 4: WaitForKeyPressWithTimeout(<space>, 2000)" + CR(1) + "Press space within 2 sec (or wait for timeout)...")
  t1 <- GetTime()
  result <- WaitForKeyPressWithTimeout("<space>", 2000)
  t2 <- GetTime()
  elapsed <- t2 - t1
  if(result == "<timeout>")
  {
    result4 <- "Timeout after " + elapsed + "ms (expected ~2000ms) - PASS"
  } else {
    result4 <- "Space pressed after " + elapsed + "ms - PASS"
  }
  PushOnEnd(results, result4)
  PrintTest(output, result4)
  Wait(1000)

  ## Test 5: WaitForKeyPressWithTimeout() - with key press
  PrintTest(output, CR(1) + "Test 5: WaitForKeyPressWithTimeout(<return>, 3000)" + CR(1) + "Press Enter...")
  t1 <- GetTime()
  result <- WaitForKeyPressWithTimeout("<return>", 3000)
  t2 <- GetTime()
  elapsed <- t2 - t1
  if(result == "<timeout>")
  {
    result5 <- "Timeout after " + elapsed + "ms - PASS"
  } else {
    result5 <- "Return pressed after " + elapsed + "ms - PASS"
  }
  PushOnEnd(results, result5)
  PrintTest(output, result5)
  Wait(1000)

  ## Test 6: WaitForListKeyPress()
  PrintTest(output, CR(1) + "Test 6: WaitForListKeyPress([<a>, <b>, <c>])" + CR(1) + "Press A, B, or C...")
  t1 <- GetTime()
  key <- WaitForListKeyPress(["<a>", "<b>", "<c>"])
  t2 <- GetTime()
  elapsed <- t2 - t1
  result6 <- "Key pressed: " + key + " after " + elapsed + "ms - PASS"
  PushOnEnd(results, result6)
  PrintTest(output, result6)
  Wait(1000)

  ## Test 7: GetInput()
  PrintTest(output, CR(1) + "Test 7: GetInput()" + CR(1) + "Type text and press Enter...")
  tb <- EasyTextBox("", gVideoWidth/2, 400, gWin, 20, 300, 30)
  Draw()
  t1 <- GetTime()
  input <- GetInput(tb, "<return>")
  t2 <- GetTime()
  elapsed <- t2 - t1
  result7 <- "Input: '" + input + "' after " + elapsed + "ms - PASS"
  PushOnEnd(results, result7)
  RemoveObject(tb, gWin)
  PrintTest(output, result7)
  Wait(1000)

  ## Display final summary
  RemoveObject(output, gWin)
  summary <- "TEST SUMMARY" + CR(2)
  loop(i, Sequence(1, Length(results), 1))
  {
    summary <- summary + i + ". " + Nth(results, i) + CR(1)
  }
  summary <- summary + CR(2) + "All tests completed successfully!" + CR(1)
  summary <- summary + "Native C++ functions with ASYNCIFY appear to work correctly." + CR(2)
  summary <- summary + "Press any key to exit..."

  summaryLabel <- EasyLabel(summary, gVideoWidth/2, 150, gWin, 16)
  SetProperty(summaryLabel, "VERTICALALIGN", "top")
  Draw()

  WaitForAnyKeyPress()
}

define PrintTest(label, text)
{
  SetText(label, text)
  Draw()
}
